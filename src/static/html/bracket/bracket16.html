<html>

<head>
    <style>
        .bg {
            position: static;
            padding: 10px;
        }
        
        .player {
            position: absolute;
            padding: 10px;
            font-size: 35px;
            color: #fff;
            width: 150px;
            text-align: center;
            font-family: "微软雅黑";
        }
        
        .blue {
            color: #003da7;
        }
        
        .white {
            color: #fff
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
    <script src="/js/socket.io.slim.min.js"></script>
</head>

<body>
    <div id="app">
        <img src="bg16.png" />
        <div>
            <div v-for="(item, index) in items" :key="item.idx">
                <div class="player blue" :style="item.s">
                    <span>{{item.name}} </span>
                </div>
                <span class="player white" :style="item.ss">{{item.score>-1?item.score:""}} </span>
            </div>
        </div>
    </div>
    <script>
        var _p = function(x, y) {
            return 'left:' + x + 'px;' + 'top:' + y + 'px;'
        }
        var app = new Vue({
            el: '#app',
            data: {
                message: 'Hello Vue22!',
                items: []
            },
            // mounted: function() {
            methods: {
                route: (recArr, playerMap, items) => {
                    let getWinner = (rec) => {
                        if (rec.score[0] != 0 || rec.score[1] != 0) {
                            if (rec.score[0] > rec.score[1])
                                return rec.player[0]
                            else
                                return rec.player[1]
                        }
                        return ''
                    }
                    let fillWinner = (fromGameId, playerId) => {
                        for (let i = 0; i < recArr.length; i++) {
                            let rec = recArr[i];
                            let a = rec.idx.split('#')
                            let gameId = a[1]
                            if (gameId.length > fromGameId.length) {
                                let pos = gameId.search(fromGameId)
                                if (pos > -1) {
                                    let arrIdx = Math.floor(pos / Number(a[0]))
                                    console.log('fillWinner from', fromGameId, 'to', gameId, arrIdx, playerMap[playerId].name);
                                    rec.player[arrIdx] = playerId
                                    return
                                }
                            }
                        }
                    }
                    let m = {
                        'A1A2E1E2': 24,
                        'B1B2F1F2': 25,
                        'C1C2G1G2': 26,
                        'D1D2H1H2': 27,
                    }
                    for (let i = 0; i < recArr.length; i++) {
                        let rec = recArr[i];
                        let a = rec.idx.split('#')
                        let gameId = a[1]
                        let winner = getWinner(rec) //ret playerId
                        if (winner) {
                            console.log(gameId, 'winner', playerMap[winner].name);
                            fillWinner(gameId, winner)
                            if (m[gameId]) {
                                item = items[m[gameId]]
                                let p1 = playerMap[winner]
                                item.name = p1.name
                            }
                        }
                    }

                }
            },
            created: function() {
                console.log(this);
                var _this = this
                var x1 = 112
                var x1r = 1652
                var scoreOfs = 93
                var pos = [
                        [x1, 80, x1 + scoreOfs],
                        [x1, 80 + 122, x1 + scoreOfs],

                        [x1, 325, x1 + scoreOfs],
                        [x1, 325 + 122, x1 + scoreOfs],

                        [x1, 575, x1 + scoreOfs],
                        [x1, 575 + 122, x1 + scoreOfs],

                        [x1, 820, x1 + scoreOfs],
                        [x1, 820 + 122, x1 + scoreOfs],
                    ]
                    //x1r
                let a = []
                for (let i = 0; i < pos.length; i++) {
                    let p = pos[i];
                    a.push([x1r, p[1], x1r - scoreOfs])
                }

                pos = pos.concat(a)

                let x2 = 359,
                    x2r = 1407
                a = [
                    [x2, 143, x2 + scoreOfs],
                    [x2, 143 + 246, x2 + scoreOfs],

                    [x2, 633 + 3, x2 + scoreOfs],
                    [x2, 633 + 3 + 246, x2 + scoreOfs],
                ]

                pos = pos.concat(a)


                for (let i = 0; i < a.length; i++) {
                    let p = a[i];
                    pos.push([x2r, p[1], x2r - scoreOfs])
                }


                let x3 = 593 + 15,
                    x3r = 1185 - 28
                a = [
                    [x3, 265, x3 + scoreOfs],
                    [x3, 265 + 492, x3 + scoreOfs],
                ]
                pos = pos.concat(a)

                for (let i = 0; i < a.length; i++) {
                    let p = a[i];
                    pos.push([x3r, p[1], x3r - scoreOfs])
                }


                for (let i = 0; i < pos.length; i++) {
                    let p = pos[i];
                    this.items.push({
                        idx: i + 1,
                        s: _p(p[0], p[1]),
                        ss: _p(p[2], p[1]),
                        score: -1,
                        name: ''
                    })
                }
                var localWs = io.connect('/rkb')
                localWs.on('connect', () => {
                        console.log('connect', window.location.host)
                    })
                    .on('sc_data', (data) => {
                        console.log('sc_data', data)
                        if (data.dbIdx == 'G32') {
                            this.route(data.rec, data.playerMap, this.items)
                            for (let i = 0; i < 12; i++) {
                                let rec = data.rec[i + 16];
                                let item1 = this.items[i * 2]
                                let item2 = this.items[i * 2 + 1]
                                let p1 = data.playerMap[rec.player[0]]
                                let p2 = data.playerMap[rec.player[1]]
                                item1.name = p1.name
                                item2.name = p2.name
                                item1.score = rec.score[0]
                                item2.score = rec.score[1]
                            }
                        }

                    })
            }
        })
    </script>
</body>